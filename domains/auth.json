{
  "domain": "Auth",
  "entities": {
    "Permission": {
      "aggregate_root": true,
      "table": "permissions",
      "fields": {
        "id": {
          "type": "bigIncrements"
        },
        "name": {
          "type": "string",
          "length": 255,
          "unique": true,
          "comment": "e.g. 'members.create', 'subscriptions.view'"
        },
        "display_name": {
          "type": "string",
          "length": 255,
          "comment": "Human-readable name"
        },
        "description": {
          "type": "text",
          "nullable": true
        },
        "module": {
          "type": "string",
          "length": 100,
          "comment": "e.g. 'members', 'subscriptions', 'finance'"
        },
        "created_at": {
          "type": "timestamp",
          "nullable": true
        },
        "updated_at": {
          "type": "timestamp",
          "nullable": true
        }
      },
      "relations": {
        "roles": {
          "type": "belongsToMany",
          "entity": "Role",
          "domain": "Auth",
          "pivot_table": "role_permissions",
          "foreign_key": "permission_id",
          "related_key": "role_id"
        }
      },
      "indexes": [
        {
          "columns": ["module", "name"]
        }
      ],
      "fillable": [
        "name",
        "display_name",
        "description",
        "module"
      ],
      "validation": {
        "name": "required|string|max:255|unique:permissions,name",
        "display_name": "required|string|max:255",
        "description": "nullable|string",
        "module": "required|string|max:100"
      }
    },
    "Role": {
      "aggregate_root": true,
      "table": "roles",
      "fields": {
        "id": {
          "type": "bigIncrements"
        },
        "organisation_id": {
          "type": "unsignedBigInteger",
          "nullable": true,
          "comment": "NULL for global roles, set for organisation-specific roles"
        },
        "name": {
          "type": "string",
          "length": 255,
          "comment": "e.g. 'super_admin', 'admin', 'read_only'"
        },
        "display_name": {
          "type": "string",
          "length": 255
        },
        "description": {
          "type": "text",
          "nullable": true
        },
        "is_system": {
          "type": "boolean",
          "default": false,
          "comment": "System roles cannot be deleted"
        },
        "created_at": {
          "type": "timestamp",
          "nullable": true
        },
        "updated_at": {
          "type": "timestamp",
          "nullable": true
        }
      },
      "relations": {
        "organisation": {
          "type": "belongsTo",
          "entity": "Organisation",
          "domain": "Tenancy",
          "foreign_key": "organisation_id"
        },
        "permissions": {
          "type": "belongsToMany",
          "entity": "Permission",
          "domain": "Auth",
          "pivot_table": "role_permissions",
          "foreign_key": "role_id",
          "related_key": "permission_id"
        },
        "users": {
          "type": "belongsToMany",
          "entity": "User",
          "domain": "Auth",
          "pivot_table": "user_roles",
          "foreign_key": "role_id",
          "related_key": "user_id"
        }
      },
      "indexes": [
        {
          "columns": ["organisation_id", "name"],
          "unique": true
        }
      ],
      "fillable": [
        "organisation_id",
        "name",
        "display_name",
        "description",
        "is_system"
      ],
      "validation": {
        "organisation_id": "nullable|exists:organisations,id",
        "name": "required|string|max:255",
        "display_name": "required|string|max:255",
        "description": "nullable|string",
        "is_system": "boolean"
      }
    },
    "RolePermission": {
      "aggregate_root": false,
      "table": "role_permissions",
      "timestamps": false,
      "fields": {
        "id": {
          "type": "bigIncrements"
        },
        "role_id": {
          "type": "unsignedBigInteger",
          "index": true
        },
        "permission_id": {
          "type": "unsignedBigInteger",
          "index": true
        }
      },
      "relations": {
        "role": {
          "type": "belongsTo",
          "entity": "Role",
          "domain": "Auth",
          "foreign_key": "role_id"
        },
        "permission": {
          "type": "belongsTo",
          "entity": "Permission",
          "domain": "Auth",
          "foreign_key": "permission_id"
        }
      },
      "indexes": [
        {
          "columns": ["role_id", "permission_id"],
          "unique": true
        }
      ],
      "fillable": [
        "role_id",
        "permission_id"
      ],
      "validation": {
        "role_id": "required|exists:roles,id",
        "permission_id": "required|exists:permissions,id"
      }
    },
    "UserRole": {
      "aggregate_root": false,
      "table": "user_roles",
      "timestamps": false,
      "fields": {
        "id": {
          "type": "bigIncrements"
        },
        "user_id": {
          "type": "unsignedBigInteger",
          "index": true
        },
        "role_id": {
          "type": "unsignedBigInteger",
          "index": true
        },
        "organisation_id": {
          "type": "unsignedBigInteger",
          "nullable": true,
          "comment": "Scopes role to specific organisation"
        }
      },
      "relations": {
        "user": {
          "type": "belongsTo",
          "entity": "User",
          "domain": "Auth",
          "foreign_key": "user_id"
        },
        "role": {
          "type": "belongsTo",
          "entity": "Role",
          "domain": "Auth",
          "foreign_key": "role_id"
        },
        "organisation": {
          "type": "belongsTo",
          "entity": "Organisation",
          "domain": "Tenancy",
          "foreign_key": "organisation_id"
        }
      },
      "indexes": [
        {
          "columns": ["user_id", "role_id", "organisation_id"],
          "unique": true
        }
      ],
      "fillable": [
        "user_id",
        "role_id",
        "organisation_id"
      ],
      "validation": {
        "user_id": "required|exists:users,id",
        "role_id": "required|exists:roles,id",
        "organisation_id": "nullable|exists:organisations,id"
      }
    },
    "TwoFactorAuthentication": {
      "aggregate_root": false,
      "table": "two_factor_authentications",
      "fields": {
        "id": {
          "type": "bigIncrements"
        },
        "user_id": {
          "type": "unsignedBigInteger",
          "unique": true
        },
        "secret": {
          "type": "string",
          "length": 255,
          "comment": "Encrypted 2FA secret"
        },
        "recovery_codes": {
          "type": "text",
          "nullable": true,
          "comment": "Encrypted recovery codes"
        },
        "enabled_at": {
          "type": "timestamp",
          "nullable": true
        },
        "created_at": {
          "type": "timestamp",
          "nullable": true
        },
        "updated_at": {
          "type": "timestamp",
          "nullable": true
        }
      },
      "relations": {
        "user": {
          "type": "belongsTo",
          "entity": "User",
          "domain": "Auth",
          "foreign_key": "user_id"
        }
      },
      "fillable": [
        "user_id",
        "secret",
        "recovery_codes",
        "enabled_at"
      ],
      "validation": {
        "user_id": "required|exists:users,id|unique:two_factor_authentications,user_id",
        "secret": "required|string|max:255",
        "recovery_codes": "nullable|string",
        "enabled_at": "nullable|date"
      }
    }
  }
}
